<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .query-result {
            max-height: 400px;
            overflow-y: auto;
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            padding: 15px;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
        }
        .message.user {
            background-color: #007bff;
            color: white;
            margin-left: 20%;
        }
        .message.assistant {
            background-color: #e9ecef;
            color: #333;
            margin-right: 20%;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .schema-tree {
            font-family: monospace;
            font-size: 0.9em;
        }
        .table-name {
            font-weight: bold;
            color: #007bff;
        }
        .column-info {
            margin-left: 20px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-database"></i> MCP PostgreSQL LLM Server
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <span id="db-status" class="status-indicator"></span>
                    Database: <span id="db-status-text">Checking...</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- System Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> System Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>Database Connection</h6>
                                <p id="db-connection-status">Loading...</p>
                            </div>
                            <div class="col-md-4">
                                <h6>LLM Providers</h6>
                                <p id="llm-providers-status">Loading...</p>
                            </div>
                            <div class="col-md-4">
                                <h6>MCP Session</h6>
                                <p id="mcp-session-status">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Interface Tabs -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="sql-tab" data-bs-toggle="tab" data-bs-target="#sql" type="button" role="tab">
                            <i class="fas fa-code"></i> SQL Query
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab">
                            <i class="fas fa-comments"></i> LLM Chat
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="natural-tab" data-bs-toggle="tab" data-bs-target="#natural" type="button" role="tab">
                            <i class="fas fa-magic"></i> Natural Language SQL
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab">
                            <i class="fas fa-chart-line"></i> Data Analysis
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="schema-tab" data-bs-toggle="tab" data-bs-target="#schema" type="button" role="tab">
                            <i class="fas fa-sitemap"></i> Database Schema
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="mainTabContent">
                    <!-- SQL Query Tab -->
                    <div class="tab-pane fade show active" id="sql" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5>Execute SQL Query</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="sqlQuery" class="form-label">SQL Query</label>
                                    <textarea class="form-control" id="sqlQuery" rows="4" placeholder="SELECT * FROM table_name;"></textarea>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="executeSQL()">
                                    <i class="fas fa-play"></i> Execute Query
                                </button>
                                <button type="button" class="btn btn-secondary ms-2" onclick="clearSQLResult()">
                                    <i class="fas fa-eraser"></i> Clear
                                </button>
                            </div>
                        </div>
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6>Query Result</h6>
                            </div>
                            <div class="card-body">
                                <div id="sqlResult" class="query-result">
                                    <p class="text-muted">No query executed yet.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- LLM Chat Tab -->
                    <div class="tab-pane fade" id="chat" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5>Chat with LLM</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <select class="form-select form-select-sm" id="chatProvider">
                                            <option value="">Auto-select Provider</option>
                                            <option value="openai">OpenAI</option>
                                            <option value="anthropic">Anthropic</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <select class="form-select form-select-sm" id="chatModel">
                                            <option value="">Auto-select Model</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="chatContainer" class="chat-container mb-3">
                                    <div class="message assistant">
                                        Hello! I'm here to help you with database queries and analysis. What would you like to know?
                                    </div>
                                </div>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="chatInput" placeholder="Type your message here..." onkeypress="handleChatKeyPress(event)">
                                    <button class="btn btn-primary" type="button" onclick="sendChatMessage()">
                                        <i class="fas fa-paper-plane"></i> Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Natural Language SQL Tab -->
                    <div class="tab-pane fade" id="natural" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5>Natural Language to SQL</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="naturalQuery" class="form-label">Describe what you want to query</label>
                                    <textarea class="form-control" id="naturalQuery" rows="3" placeholder="e.g., Show me all users who registered in the last 30 days"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="tableContext" class="form-label">Additional Context (optional)</label>
                                    <textarea class="form-control" id="tableContext" rows="2" placeholder="Provide any additional context about table relationships or constraints"></textarea>
                                </div>
                                <div class="mb-3">
                                    <select class="form-select" id="sqlProvider">
                                        <option value="">Auto-select Provider</option>
                                        <option value="openai">OpenAI</option>
                                        <option value="anthropic">Anthropic</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-success" onclick="generateSQL()">
                                    <i class="fas fa-magic"></i> Generate & Execute SQL
                                </button>
                            </div>
                        </div>
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6>Generated SQL & Results</h6>
                            </div>
                            <div class="card-body">
                                <div id="naturalResult" class="query-result">
                                    <p class="text-muted">No query generated yet.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Analysis Tab -->
                    <div class="tab-pane fade" id="analysis" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5>Data Analysis with LLM</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="analysisQuery" class="form-label">SQL Query</label>
                                    <textarea class="form-control" id="analysisQuery" rows="3" placeholder="SELECT * FROM table_name WHERE condition;"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="analysisRequest" class="form-label">Analysis Request</label>
                                    <textarea class="form-control" id="analysisRequest" rows="3" placeholder="What insights would you like? e.g., trends, patterns, recommendations"></textarea>
                                </div>
                                <div class="mb-3">
                                    <select class="form-select" id="analysisProvider">
                                        <option value="">Auto-select Provider</option>
                                        <option value="openai">OpenAI</option>
                                        <option value="anthropic">Anthropic</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-info" onclick="analyzeData()">
                                    <i class="fas fa-chart-line"></i> Analyze Data
                                </button>
                            </div>
                        </div>
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6>Analysis Results</h6>
                            </div>
                            <div class="card-body">
                                <div id="analysisResult" class="query-result">
                                    <p class="text-muted">No analysis performed yet.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Database Schema Tab -->
                    <div class="tab-pane fade" id="schema" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5>Database Schema</h5>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadSchema()">
                                    <i class="fas fa-refresh"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="schemaContent" class="schema-tree">
                                    <p class="text-muted">Loading schema...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let systemStatus = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadSystemStatus();
            loadSchema();
            loadAvailableModels();
        });

        // Load system status
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/status');
                systemStatus = await response.json();
                
                updateStatusDisplay();
            } catch (error) {
                console.error('Error loading system status:', error);
                updateStatusDisplay(false);
            }
        }

        // Update status display
        function updateStatusDisplay(connected = null) {
            const dbStatus = document.getElementById('db-status');
            const dbStatusText = document.getElementById('db-status-text');
            const dbConnection = document.getElementById('db-connection-status');
            const llmProviders = document.getElementById('llm-providers-status');
            const mcpSession = document.getElementById('mcp-session-status');

            if (connected === false || !systemStatus.database_connected) {
                dbStatus.className = 'status-indicator status-disconnected';
                dbStatusText.textContent = 'Disconnected';
                dbConnection.innerHTML = '<span class="text-danger">❌ Disconnected</span>';
            } else {
                dbStatus.className = 'status-indicator status-connected';
                dbStatusText.textContent = 'Connected';
                dbConnection.innerHTML = '<span class="text-success">✅ Connected</span>';
            }

            if (systemStatus.llm_providers) {
                llmProviders.innerHTML = systemStatus.llm_providers.length > 0 
                    ? `<span class="text-success">✅ ${systemStatus.llm_providers.join(', ')}</span>`
                    : '<span class="text-warning">⚠️ No providers configured</span>';
            }

            if (systemStatus.mcp_session_id) {
                mcpSession.innerHTML = `<span class="text-success">✅ ${systemStatus.mcp_session_id.substring(0, 8)}...</span>`;
            }
        }

        // Load available models
        async function loadAvailableModels() {
            if (!systemStatus.available_models) return;

            const chatModel = document.getElementById('chatModel');
            chatModel.innerHTML = '<option value="">Auto-select Model</option>';

            for (const [provider, models] of Object.entries(systemStatus.available_models)) {
                for (const model of models) {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = `${provider}: ${model}`;
                    chatModel.appendChild(option);
                }
            }
        }

        // Execute SQL query
        async function executeSQL() {
            const query = document.getElementById('sqlQuery').value.trim();
            if (!query) {
                alert('Please enter a SQL query');
                return;
            }

            const resultDiv = document.getElementById('sqlResult');
            resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';

            try {
                const response = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query })
                });

                const result = await response.json();
                
                if (response.ok) {
                    displayQueryResult(result, resultDiv);
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.detail || 'Unknown error'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
            }
        }

        // Display query result
        function displayQueryResult(result, container) {
            if (result.columns && result.rows) {
                let html = `<div class="alert alert-success">Query executed successfully. ${result.row_count} rows returned.</div>`;
                
                if (result.row_count > 0) {
                    html += '<div class="table-responsive"><table class="table table-striped table-sm">';
                    html += '<thead class="table-dark"><tr>';
                    result.columns.forEach(col => {
                        html += `<th>${col}</th>`;
                    });
                    html += '</tr></thead><tbody>';
                    
                    result.rows.forEach(row => {
                        html += '<tr>';
                        row.forEach(cell => {
                            html += `<td>${cell !== null ? cell : '<em>null</em>'}</td>`;
                        });
                        html += '</tr>';
                    });
                    html += '</tbody></table></div>';
                }
                
                container.innerHTML = html;
            } else {
                container.innerHTML = `<div class="alert alert-info">${result.message || 'Query executed successfully'}</div>`;
            }
        }

        // Clear SQL result
        function clearSQLResult() {
            document.getElementById('sqlResult').innerHTML = '<p class="text-muted">No query executed yet.</p>';
            document.getElementById('sqlQuery').value = '';
        }

        // Chat functionality
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            const container = document.getElementById('chatContainer');
            
            // Add user message
            const userMsg = document.createElement('div');
            userMsg.className = 'message user';
            userMsg.textContent = message;
            container.appendChild(userMsg);
            
            input.value = '';
            container.scrollTop = container.scrollHeight;

            // Add loading indicator
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'message assistant';
            loadingMsg.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Thinking...';
            container.appendChild(loadingMsg);
            container.scrollTop = container.scrollHeight;

            try {
                const provider = document.getElementById('chatProvider').value;
                const model = document.getElementById('chatModel').value;

                const response = await fetch('/api/llm/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        provider: provider || null,
                        model: model || null
                    })
                });

                const result = await response.json();
                
                // Remove loading message
                container.removeChild(loadingMsg);
                
                if (response.ok) {
                    const assistantMsg = document.createElement('div');
                    assistantMsg.className = 'message assistant';
                    assistantMsg.textContent = result.response;
                    container.appendChild(assistantMsg);
                } else {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'message assistant';
                    errorMsg.innerHTML = `<span class="text-danger">Error: ${result.detail || 'Unknown error'}</span>`;
                    container.appendChild(errorMsg);
                }
            } catch (error) {
                container.removeChild(loadingMsg);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'message assistant';
                errorMsg.innerHTML = `<span class="text-danger">Network error: ${error.message}</span>`;
                container.appendChild(errorMsg);
            }

            container.scrollTop = container.scrollHeight;
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        // Generate SQL from natural language
        async function generateSQL() {
            const naturalQuery = document.getElementById('naturalQuery').value.trim();
            if (!naturalQuery) {
                alert('Please describe what you want to query');
                return;
            }

            const resultDiv = document.getElementById('naturalResult');
            resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';

            try {
                const tableContext = document.getElementById('tableContext').value;
                const provider = document.getElementById('sqlProvider').value;

                const response = await fetch('/api/llm/sql-generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        natural_query: naturalQuery,
                        table_context: tableContext,
                        provider: provider || null
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    let html = `<h6>Natural Language Query:</h6><p class="text-muted">${result.natural_language_query}</p>`;
                    html += `<h6>Generated SQL:</h6><pre class="bg-light p-2"><code>${result.generated_sql}</code></pre>`;
                    html += `<h6>Execution Result:</h6>`;
                    
                    const tempDiv = document.createElement('div');
                    displayQueryResult(result.execution_result, tempDiv);
                    html += tempDiv.innerHTML;
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.detail || 'Unknown error'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
            }
        }

        // Analyze data
        async function analyzeData() {
            const query = document.getElementById('analysisQuery').value.trim();
            const analysisRequest = document.getElementById('analysisRequest').value.trim();
            
            if (!query || !analysisRequest) {
                alert('Please provide both SQL query and analysis request');
                return;
            }

            const resultDiv = document.getElementById('analysisResult');
            resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';

            try {
                const provider = document.getElementById('analysisProvider').value;

                const response = await fetch('/api/llm/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        analysis_request: analysisRequest,
                        provider: provider || null
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    let html = `<h6>Query:</h6><pre class="bg-light p-2"><code>${result.query}</code></pre>`;
                    html += `<h6>Data Summary:</h6>`;
                    
                    if (result.data.columns && result.data.rows) {
                        html += `<p>Returned ${result.data.row_count} rows with columns: ${result.data.columns.join(', ')}</p>`;
                    }
                    
                    html += `<h6>Analysis:</h6><div class="alert alert-info">${result.analysis.replace(/\n/g, '<br>')}</div>`;
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.detail || 'Unknown error'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
            }
        }

        // Load database schema
        async function loadSchema() {
            const container = document.getElementById('schemaContent');
            container.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';

            try {
                const response = await fetch('/api/database/schema');
                const schema = await response.json();
                
                if (response.ok) {
                    displaySchema(schema, container);
                } else {
                    container.innerHTML = `<div class="alert alert-danger">Error loading schema: ${schema.detail || 'Unknown error'}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
            }
        }

        // Display database schema
        function displaySchema(schema, container) {
            let html = '';
            
            for (const [tableName, columns] of Object.entries(schema)) {
                html += `<div class="mb-3">`;
                html += `<div class="table-name"><i class="fas fa-table"></i> ${tableName}</div>`;
                
                columns.forEach(col => {
                    const nullable = col.nullable ? 'NULL' : 'NOT NULL';
                    const defaultVal = col.default ? ` DEFAULT ${col.default}` : '';
                    html += `<div class="column-info">├─ <strong>${col.column}</strong> ${col.type} ${nullable}${defaultVal}</div>`;
                });
                
                html += `</div>`;
            }
            
            container.innerHTML = html || '<p class="text-muted">No tables found.</p>';
        }

        // Refresh status periodically
        setInterval(loadSystemStatus, 30000); // Every 30 seconds
    </script>
</body>
</html>